<?xml version="1.0" encoding="UTF-8"?>
<databaseChangeLog
        xmlns="http://www.liquibase.org/xml/ns/dbchangelog"
        xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
        xmlns:ext="http://www.liquibase.org/xml/ns/dbchangelog-ext"
        xmlns:pro="http://www.liquibase.org/xml/ns/pro"
        xsi:schemaLocation="http://www.liquibase.org/xml/ns/dbchangelog
        http://www.liquibase.org/xml/ns/dbchangelog/dbchangelog-latest.xsd
        http://www.liquibase.org/xml/ns/dbchangelog-ext
        http://www.liquibase.org/xml/ns/dbchangelog/dbchangelog-ext.xsd
        http://www.liquibase.org/xml/ns/pro
        http://www.liquibase.org/xml/ns/pro/liquibase-pro-latest.xsd">
    
    <changeSet id="1" author="zavarykin">
        <preConditions onFail="MARK_RAN">
            <not>
                <tableExists tableName="users"/>
            </not>
        </preConditions>
        <createTable tableName="users">
            <column name="username" type="varchar">
                <constraints 
                        primaryKey="true" 
                        primaryKeyName="pk_user"
                        nullable="false" 
                        unique="true"/>
            </column>
            <column name="password" type="varchar">
                <constraints nullable="false"/>
            </column>
            <column name="enabled" type="boolean" defaultValueBoolean="false">
                <constraints nullable="false"/>
            </column>
        </createTable>
    </changeSet>
    
    <changeSet id="2" author="zavarykin">
        <preConditions onFail="MARK_RAN">
            <not>
                <tableExists tableName="authorities"/>
            </not>
        </preConditions>
        <createTable tableName="authorities">
            <column name="authority" type="varchar">
                <constraints nullable="false"/>
            </column>
            <column name="username" type="varchar">
                <constraints foreignKeyName="fk_authority_to_user"
                             references="users(username)"
                             nullable="false"/>
            </column>
        </createTable>
    </changeSet>
    
    <changeSet id="3" author="zavarykin">
        <preConditions onFail="MARK_RAN">
            <columnExists tableName="authorities" columnName="authority"/>
            <columnExists tableName="authorities" columnName="username"/>
            <not>
                <primaryKeyExists tableName="authorities"/>
            </not>
        </preConditions>
        <addPrimaryKey tableName="authorities"
                       columnNames="authority,username"
                       constraintName="pk_authority"/>
    </changeSet>

    <changeSet id="4" author="zavarykin">
        <preConditions onFail="MARK_RAN">
            <not>
                <tableExists tableName="emails"/>
            </not>
        </preConditions>
        <createTable tableName="emails">
            <column name="address" type="varchar">
                <constraints
                        primaryKey="true"
                        primaryKeyName="pk_email"
                        nullable="false"
                        unique="true"/>
            </column>
            <column name="username" type="varchar">
                <constraints foreignKeyName="fk_email_to_user"
                             references="users(username)"
                             nullable="false"/>
            </column>
        </createTable>
        <createIndex tableName="emails" indexName="idx_emails">
            <column name="username"/>
        </createIndex>
    </changeSet>

    <changeSet id="5" author="zavarykin">
        <preConditions onFail="MARK_RAN">
            <not>
                <tableExists tableName="tokens"/>
            </not>
        </preConditions>
        <createTable tableName="tokens">
            <column name="token" type="varchar">
                <constraints
                        primaryKey="true"
                        primaryKeyName="pk_token"
                        nullable="false"
                        unique="true"/>
            </column>
            <column name="username" type="varchar">
                <constraints foreignKeyName="fk_token_to_user"
                             references="users(username)"
                             nullable="false"/>
            </column>
        </createTable>
    </changeSet>

    <changeSet id="6" author="zavarykin">
        <preConditions onFail="MARK_RAN">
            <not>
                <tableExists tableName="profiles"/>
            </not>
        </preConditions>
        <createTable tableName="profiles">
            <column name="username" type="varchar">
                <constraints primaryKey="true"
                             primaryKeyName="pk_profile"
                             foreignKeyName="fk_profile_to_user"
                             references="users(username)"
                             nullable="true"
                             unique="true"/>
            </column>
            <column name="firstname" type="varchar">
                <constraints nullable="false"/>
            </column>
            <column name="lastname" type="varchar">
                <constraints nullable="false"/>
            </column>
        </createTable>
    </changeSet>

    <changeSet id="7" author="zavarykin">
        <preConditions onFail="MARK_RAN">
            <not>
                <tableExists tableName="mentors"/>
            </not>
        </preConditions>
        <createTable tableName="mentors">
            <column name="username" type="varchar">
                <constraints primaryKey="true"
                             primaryKeyName="pk_mentor"
                             foreignKeyName="fk_mentor_to_profile"
                             references="profiles(username)"
                             nullable="false"
                             unique="true"/>
            </column>
            <column name="about" type="varchar">
                <constraints nullable="false"/>
            </column>
            <column name="job_title" type="varchar">
                <constraints nullable="false"/>
            </column>
            <column name="company" type="varchar">
                <constraints nullable="false"/>
            </column>
            <column name="confirm" type="boolean" defaultValueBoolean="false">
                <constraints nullable="false"/>
            </column>
            <column name="experience" type="integer">
                <constraints nullable="false"/>
            </column>
        </createTable>
    </changeSet>

    <changeSet id="8" author="zavarykin">
        <preConditions onFail="MARK_RAN">
            <not>
                <tableExists tableName="categories"/>
            </not>
        </preConditions>
        <createTable tableName="categories">
            <column name="name" type="varchar">
                <constraints primaryKey="true"
                             primaryKeyName="pk_category"
                             nullable="false"
                             unique="true"/>
            </column>
        </createTable>
    </changeSet>

    <changeSet id="9" author="zavarykin">
        <preConditions onFail="MARK_RAN">
            <not>
                <tableExists tableName="mentor_category"/>
            </not>
        </preConditions>
        <createTable tableName="mentor_category">
            <column name="mentor" type="varchar">
                <constraints foreignKeyName="fk_mentor_to_category"
                             references="mentors(username)"
                             nullable="false"/>
            </column>
            <column name="category" type="varchar">
                <constraints foreignKeyName="fk_category_to_mentor"
                             references="categories(name)"
                             nullable="false"/>
            </column>
        </createTable>
    </changeSet>

    <changeSet id="10" author="zavarykin">
        <preConditions>
            <columnExists tableName="mentor_category" columnName="mentor"/>
            <columnExists tableName="mentor_category" columnName="category"/>
        </preConditions>
        <addPrimaryKey tableName="mentor_category"
                       columnNames="mentor,category"
                       constraintName="pk_mentor_category"/>
    </changeSet>

    <changeSet id="11" author="zavarykin">
        <preConditions onFail="MARK_RAN">
            <not>
                <tableExists tableName="specializations"/>
            </not>
        </preConditions>
        <createTable tableName="specializations">
            <column name="name" type="varchar">
                <constraints nullable="false"/>
            </column>
            <column name="category" type="varchar">
                <constraints foreignKeyName="fk_specialization_to_category"
                             references="categories(name)"
                             nullable="false"/>
            </column>
        </createTable>
        <addPrimaryKey tableName="specializations"
                       columnNames="name,category"
                       constraintName="pk_specialization"/>
    </changeSet>

    <changeSet id="12" author="zavarykin">
        <preConditions onFail="MARK_RAN">
            <not>
                <tableExists tableName="mentor_specialization"/>
            </not>
        </preConditions>
        <createTable tableName="mentor_specialization">
            <column name="mentor" type="varchar">
                <constraints foreignKeyName="fk_mentor_specialization"
                             references="mentors(username)"
                             nullable="false"/>
            </column>
            <column name="specialization" type="varchar">
                <constraints nullable="false"/>
            </column>
            <column name="category" type="varchar">
                <constraints nullable="false"/>
            </column>
        </createTable>
        <addForeignKeyConstraint baseTableName="mentor_specialization"
                                 baseColumnNames="specialization,category"
                                 constraintName="fk_specialization_mentor"
                                 referencedTableName="specializations"
                                 referencedColumnNames="name,category"/>
    </changeSet>

    <changeSet id="13" author="zavarykin">
        <preConditions onFail="MARK_RAN">
            <not>
                <primaryKeyExists tableName="mentor_specialization"
                                  primaryKeyName="pk_mentor_specialization"/>
            </not>
        </preConditions>
        <addPrimaryKey tableName="mentor_specialization"
                       columnNames="mentor,specialization,category"
                       constraintName="pk_mentor_specialization"/>
    </changeSet>

    <changeSet id="14" author="zavarykin">
        <preConditions onFail="MARK_RAN">
            <not>
                <tableExists tableName="skills"/>
            </not>
        </preConditions>
        <createTable tableName="skills">
            <column name="name" type="varchar">
                <constraints primaryKey="true"
                             primaryKeyName="pk_skill"
                             nullable="false"
                             unique="true"/>
            </column>
        </createTable>
    </changeSet>

    <changeSet id="15" author="zavarykin">
        <preConditions onFail="MARK_RAN">
            <not>
                <tableExists tableName="mentor_skill"/>
            </not>
        </preConditions>
        <createTable tableName="mentor_skill">
            <column name="mentor" type="varchar">
                <constraints foreignKeyName="fk_mentor_skill"
                             references="mentors(username)"
                             nullable="false"/>
            </column>
            <column name="skill" type="varchar">
                <constraints foreignKeyName="fk_skill_mentor"
                             references="skills(name)"
                             nullable="false"/>
            </column>
        </createTable>
        <addPrimaryKey tableName="mentor_skill"
                       columnNames="mentor,skill"
                       constraintName="pk_mentor_skills"/>
    </changeSet>


</databaseChangeLog>